<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Gallery</title>
    <link rel="stylesheet" href="../styles/style.css"> 
</head>
<body>

    <div class="app-container">

        <header>
            <h1 data-text="Games" class="glitch-text">Games</h1>
            <nav>
                <a href="../index.html" class="btn nav-btn">Home</a>

            </nav>
        </header>

        <div id="notification-container" class="notification-container"></div>

        <main>
            <div id="developer-controls" class="hidden" style="margin-bottom: 30px;">
                <button id="add-game-button" class="btn">
                    Post a New Game
                </button>
            </div>
            
            <div id="games-grid" class="games-grid">
                <div class="full-span loading-message" id="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading games...</p>
                </div>
            </div>
        </main>

        <div id="add-game-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Post New Game</h2>
                    <button id="close-modal-button" class="close-modal-btn">X</button>
                </div>
                <form id="game-form" class="form-field-group">
                    <input type="text" id="game-title" placeholder="Game Title" required class="input-field">
                    <textarea id="game-description" placeholder="Description" required class="input-field"></textarea>
                    <input type="file" id="game-cover-photo" accept="image/*" required>
                    <input type="url" id="game-download-link" placeholder="Download Link (e.g., https://yoursite.com/game.zip)" required class="input-field">
                    <div id="upload-status" class="upload-status"></div>
                    <button type="submit" id="submit-button" class="submit-button">
                        <span id="submit-text">Post Game</span>
                        <div id="submit-spinner" class="spinner hidden" style="width: 20px; height: 20px; border-width: 3px; margin: 0 auto;"></div>
                    </button>
                </form>
            </div>
        </div>

        <div id="edit-game-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Game</h2>
                    <button id="close-edit-modal-button" class="close-modal-btn">X</button>
                </div>
                <form id="edit-game-form" class="form-field-group">
                    <input type="hidden" id="edit-game-id"> 
                    <input type="text" id="edit-game-title" placeholder="Game Title" required class="input-field">
                    <textarea id="edit-game-description" placeholder="Description" required class="input-field"></textarea>
                    <p>Change Cover Photo (Optional):</p>
                    <input type="file" id="edit-game-cover-photo" accept="image/*">
                    <input type="url" id="edit-game-download-link" placeholder="Download Link" required class="input-field">
                    <div id="edit-upload-status" class="upload-status"></div>
                    <button type="submit" id="edit-submit-button" class="submit-button">
                        <span id="edit-submit-text">Save Changes</span>
                        <div id="edit-submit-spinner" class="spinner hidden" style="width: 20px; height: 20px; border-width: 3px; margin: 0 auto;"></div>
                    </button>
                </form>
            </div>
        </div>

    </div>

<script type="module">
    // Import necessary Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, get, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"; 

    // ðŸ›‘ --- HARDCODED FIREBASE & CLOUDINARY CONFIGS (REPLACE THESE) --- ðŸ›‘
    const firebaseConfig = {
        apiKey: "AIzaSyAUZZBN9qoM34lsvyEOeK2znSSw6kKMcEE",
        authDomain: "yikegames-website.firebaseapp.com",
        databaseURL: "https://yikegames-website-default-rtdb.firebaseio.com/",
        projectId: "yikegames-website",
        storageBucket: "yikegames-website.firebasestorage.app",
        messagingSenderId: "1086586566551",
        appId: "1:1086586566551:web:b64dfc25e6e6ac5a09b6d2",
        measurementId: "G-FXH0D07D86"
    };
    
    const CLOUDINARY_CLOUD_NAME = "dhptbygpt";
    const CLOUDINARY_UPLOAD_PRESET = "unsigned_upload";
    // ðŸ›‘ --- END CONFIGS --- ðŸ›‘

    let app;
    let auth;
    let db;
    let currentUserIsDeveloper = false;
    let currentUserId = null;
    let allGamesData = {}; // Cache to hold all games for easy access

    // --- UI Elements ---
    const gamesGrid = document.getElementById('games-grid');
    const developerControls = document.getElementById('developer-controls');
    const addGameButton = document.getElementById('add-game-button');
    const addGameModal = document.getElementById('add-game-modal');
    const closeModalButton = document.getElementById('close-modal-button');
    const gameForm = document.getElementById('game-form');
    const submitButton = document.getElementById('submit-button');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    const notificationContainer = document.getElementById('notification-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const editGameModal = document.getElementById('edit-game-modal');
    const closeEditModalButton = document.getElementById('close-edit-modal-button');
    const editGameForm = document.getElementById('edit-game-form');
    const editSubmitButton = document.getElementById('edit-submit-button');
    const editSubmitText = document.getElementById('edit-submit-text');
    const editSubmitSpinner = document.getElementById('edit-submit-spinner');
    const editUploadStatus = document.getElementById('edit-upload-status');
    
    // --- Utility Functions ---

    function showNotification(message, isSuccess) {
        const notification = document.createElement('div');
        notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
        notification.textContent = message;
        notificationContainer.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    }

    function toggleLoading(isLoading, submitBtn, submitTxt, submitSpin) {
        if (isLoading) {
            submitTxt.classList.add('hidden');
            submitSpin.classList.remove('hidden');
            submitBtn.disabled = true;
        } else {
            submitTxt.classList.remove('hidden');
            submitSpin.classList.add('hidden');
            submitBtn.disabled = false;
        }
    }

    async function uploadImageToCloudinary(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                throw new Error('Image upload failed');
            }

            const data = await response.json();
            return data.secure_url;
        } catch (error) {
            console.error("Cloudinary upload error:", error);
            throw error;
        }
    }

    // --- Rendering Functions ---

    /**
     * Renders a single game card.
     * @param {string} key - The game's Firebase key.
     * @param {object} gameData - The game data.
     */
    function renderGameCard(key, gameData) {
        const gameCard = document.createElement('div');
        gameCard.id = `game-${key}`;
        gameCard.className = 'game-card';
        
        const developerControlsHTML = currentUserIsDeveloper ? `
            <div class="developer-overlay">
                <button 
                    class="delete-btn js-delete-btn" 
                    data-game-id="${key}" 
                >
                    DELETE
                </button>
                <button 
                    class="edit-btn js-edit-btn" 
                    data-game-id="${key}" 
                >
                    EDIT
                </button>
            </div>
        ` : '';

        // ðŸ”¥ CRITICAL FIX: The HTML structure is changed to separate the background layer
        gameCard.innerHTML = `
            <div class="game-card-image-container">
                <div 
                    class="game-card-image-background" 
                    style="background-image: url('${gameData.coverPhotoUrl}');"
                ></div>
                <img src="${gameData.coverPhotoUrl}" alt="${gameData.title} cover photo" class="game-card-image">
                ${developerControlsHTML}
            </div>
            <div class="game-card-content">
                <h3 class="game-card-title">${gameData.title}</h3>
                <p class="game-card-description">${gameData.description}</p>
                <span class="game-card-author">Developer: ${gameData.author}</span>
                <a href="${gameData.downloadLink}" target="_blank" rel="noopener noreferrer" class="game-card-link">
                    DOWNLOAD
                </a>
            </div>
        `;
        
        // Remove the previous JavaScript background style setting
        
        gamesGrid.appendChild(gameCard);
    }
    
    /**
     * Clears the grid and re-renders all games from the cache (allGamesData)
     * using the current developer status.
     */
    function reRenderAllGames() {
        gamesGrid.innerHTML = '';
        if (Object.keys(allGamesData).length > 0) {
            const gamesArray = Object.keys(allGamesData).map(key => ({ key, ...allGamesData[key] }));
            gamesArray.reverse().forEach(game => {
                renderGameCard(game.key, game);
            });
        } else {
            gamesGrid.innerHTML = '<p class="full-span" style="text-align: center; margin-top: 20px;">NO GAME DATA FOUND. INITIALIZING DATABASE...</p>';
        }
    }

    // --- CRUD Functions (Called by Event Delegation) ---

    async function deleteGame(gameId) {
        if (!currentUserIsDeveloper) {
            showNotification("Permission Denied: You must be a developer to delete games.", false);
            return;
        }
        if (confirm("SYSTEM ALERT: Confirm deletion of game ID: " + gameId + "? This action is IRREVERSIBLE.")) {
            try {
                await remove(ref(db, `games/${gameId}`));
                showNotification("Game deleted successfully! New entry logged.", true);
            } catch (error) {
                console.error("Error deleting game:", error);
                showNotification("ERROR: Failed to delete game. " + error.message, false);
            }
        }
    }

    function openEditModal(gameId) {
        if (!currentUserIsDeveloper) {
            showNotification("Permission Denied: You must be a developer to edit games.", false);
            return;
        }
        
        const gameData = allGamesData[gameId];
        if (!gameData) {
            showNotification("Error: Game data not found for ID: " + gameId, false);
            return;
        }

        document.getElementById('edit-game-id').value = gameId;
        document.getElementById('edit-game-title').value = gameData.title;
        document.getElementById('edit-game-description').value = gameData.description;
        document.getElementById('edit-game-download-link').value = gameData.downloadLink;
        editUploadStatus.textContent = "Current cover photo: " + gameData.coverPhotoUrl.substring(0, 40) + "...";

        editGameModal.classList.remove('hidden');
    }

    // --- Firebase & App Initialization ---
    window.addEventListener('load', async () => {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                console.error("CRITICAL AUTH WARNING: Custom token not found. App will run in unauthenticated read-only mode, and posting/deletion may fail.");
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    const userRef = ref(db, 'users/' + user.uid);
                    const snapshot = await get(userRef);
                    
                    const isDeveloperBefore = currentUserIsDeveloper; // Store previous state
                    currentUserIsDeveloper = snapshot.exists() ? snapshot.val().isDeveloper === true : false;
                    
                    if (currentUserIsDeveloper) {
                        developerControls.classList.remove('hidden');
                    } else {
                        developerControls.classList.add('hidden');
                    }
                    
                    // FIX: Re-render all games if the developer status changed.
                    // This ensures the edit/delete buttons appear on all existing cards.
                    if (currentUserIsDeveloper !== isDeveloperBefore && Object.keys(allGamesData).length > 0) {
                        reRenderAllGames();
                    }
                } else {
                    currentUserId = null;
                    currentUserIsDeveloper = false;
                    developerControls.classList.add('hidden');
                    // If a developer logs out, re-render to hide buttons
                    if (Object.keys(allGamesData).length > 0) {
                        reRenderAllGames();
                    }
                }
            });

            // This listener populates the grid and updates the cache
            onValue(ref(db, 'games'), (snapshot) => {
                loadingSpinner.classList.add('hidden');
                if (snapshot.exists()) {
                    allGamesData = snapshot.val(); 
                } else {
                    allGamesData = {}; 
                }
                // FIX: Call the re-render function here which uses the latest games data AND the current developer status.
                reRenderAllGames();
            }, (error) => {
                console.error("Error fetching games data:", error);
                loadingSpinner.classList.add('hidden');
                gamesGrid.innerHTML = '<p class="full-span" style="text-align: center; color: #ff007f;">DATA FETCH ERROR. Check console for details.</p>';
            });

        } catch (error) {
            console.error("CRITICAL FIREBASE INITIALIZATION ERROR:", error);
            showNotification("INIT FAILED. " + error.message, false);
            loadingSpinner.classList.add('hidden');
            gamesGrid.innerHTML = '<p class="full-span" style="text-align: center; color: #ff007f;">SYSTEM FAILURE. Cannot connect to Firebase.</p>';
        }
    });

    // --- Event Delegation (FIX: Handles Edit/Delete clicks on all dynamic cards) ---
    gamesGrid.addEventListener('click', (e) => {
        const target = e.target;
        const gameId = target.getAttribute('data-game-id');

        // 1. Handle DELETE click
        if (target.classList.contains('js-delete-btn') && gameId) {
            deleteGame(gameId); 
        }

        // 2. Handle EDIT click
        if (target.classList.contains('js-edit-btn') && gameId) {
            openEditModal(gameId);
        }
    });

    // Other Modal Listeners
    addGameButton.addEventListener('click', () => {
        addGameModal.classList.remove('hidden');
    });

    closeModalButton.addEventListener('click', () => {
        addGameModal.classList.add('hidden');
        gameForm.reset();
        document.getElementById('upload-status').textContent = "";
    });

    closeEditModalButton.addEventListener('click', () => {
        editGameModal.classList.add('hidden');
        editGameForm.reset();
        editUploadStatus.textContent = "";
    });

    // POST NEW GAME Form Submission (CREATE)
    gameForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentUserIsDeveloper) {
            showNotification("PERMISSION DENIED: You are not authorized to post games.", false);
            return;
        }

        toggleLoading(true, submitButton, submitText, submitSpinner);

        const title = document.getElementById('game-title').value;
        const description = document.getElementById('game-description').value;
        const coverPhotoFile = document.getElementById('game-cover-photo').files[0];
        const downloadLink = document.getElementById('game-download-link').value;
        
        if (CLOUDINARY_CLOUD_NAME.includes("YOUR_CLOUDINARY") || CLOUDINARY_UPLOAD_PRESET.includes("YOUR_CLOUDINARY")) {
             showNotification("CONFIGURATION ERROR: Cloudinary credentials missing.", false);
             toggleLoading(false, submitButton, submitText, submitSpinner);
             return;
        }

        let coverPhotoUrl;
        try {
            const uploadStatus = document.getElementById('upload-status');
            uploadStatus.textContent = "UPLOADING IMAGE TO CLOUDINARY...";
            coverPhotoUrl = await uploadImageToCloudinary(coverPhotoFile);
            uploadStatus.textContent = "IMAGE UPLOAD COMPLETE. SAVING GAME DATA...";

            const userRef = ref(db, 'users/' + currentUserId);
            const userSnapshot = await get(userRef);
            const authorName = userSnapshot.exists() ? userSnapshot.val().displayName || "Developer" : "Developer";

            const newGame = {
                title: title,
                coverPhotoUrl: coverPhotoUrl,
                description: description,
                downloadLink: downloadLink,
                author: authorName,
                timestamp: Date.now()
            };

            await push(ref(db, 'games'), newGame);
            
            showNotification("Game post successful! New entry logged.", true);
            addGameModal.classList.add('hidden');
            gameForm.reset();
            uploadStatus.textContent = "";

        } catch (error) {
            console.error("CRITICAL POSTING ERROR:", error);
            showNotification("POSTING FAILED. " + error.message, false);
        } finally {
            toggleLoading(false, submitButton, submitText, submitSpinner);
        }
    });
    
    // EDIT GAME Form Submission (UPDATE) 
    editGameForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentUserIsDeveloper) {
            showNotification("PERMISSION DENIED: You are not authorized to edit games.", false);
            return;
        }

        toggleLoading(true, editSubmitButton, editSubmitText, editSubmitSpinner);

        const gameId = document.getElementById('edit-game-id').value;
        const title = document.getElementById('edit-game-title').value;
        const description = document.getElementById('edit-game-description').value;
        const coverPhotoFile = document.getElementById('edit-game-cover-photo').files[0];
        const downloadLink = document.getElementById('edit-game-download-link').value;
        
        let coverPhotoUrl = allGamesData[gameId].coverPhotoUrl; 

        try {
            if (coverPhotoFile) {
                editUploadStatus.textContent = "UPLOADING NEW IMAGE TO CLOUDINARY...";
                if (CLOUDINARY_CLOUD_NAME.includes("YOUR_CLOUDINARY")) {
                     throw new Error("Cloudinary configuration missing.");
                }
                coverPhotoUrl = await uploadImageToCloudinary(coverPhotoFile);
            }
            editUploadStatus.textContent = "IMAGE HANDLING COMPLETE. SAVING GAME DATA...";
            
            const updatedGameData = {
                title: title,
                description: description,
                downloadLink: downloadLink,
                coverPhotoUrl: coverPhotoUrl, 
                lastUpdated: Date.now()
            };
            
            await update(ref(db, `games/${gameId}`), updatedGameData);

            showNotification(`Game "${title}" updated successfully!`, true);
            editGameModal.classList.add('hidden');
            editGameForm.reset();
            editUploadStatus.textContent = "";

        } catch (error) {
            console.error("CRITICAL EDITING ERROR:", error);
            showNotification("EDITING FAILED. " + error.message, false);
        } finally {
            toggleLoading(false, editSubmitButton, editSubmitText, editSubmitSpinner);
        }

    });
</script>
</body>
</html>
