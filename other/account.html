<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Account Page</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../styles/style.css">

<style>
  /* --- Modal Styles --- */
  .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 100; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  }

  .modal-content {
      background-color: #333; /* Dark background */
      margin: 15% auto; /* 15% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be adjusted */
      max-width: 500px;
      border-radius: 8px;
      color: white;
      position: relative;
  }

  .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
  }

  .close-btn:hover,
  .close-btn:focus {
      color: white;
      text-decoration: none;
      cursor: pointer;
  }

  #developers-list {
      list-style: none;
      padding: 0;
      margin-top: 15px;
  }

  #developers-list li {
      background-color: #444;
      padding: 8px;
      margin-bottom: 5px;
      border-left: 3px solid #00ff00;
      border-radius: 4px;
  }
  
  .logout-btn-container {
  }

  /* Your other custom CSS styles should go here */
</style>
</head>
<body>
    <div class="cursor"></div>

    <header>
        <h1>My Account</h1>
        <a href="../index.html">
            <button class="btn">Back</button>
        </a>
    </header>

    <div class="login-container">
        <h2>Logged in as: <span id="user-display-name"></span></h2>
        <div class="username-change">
            <input type="text" id="newUsername" placeholder="New Username" class="input-field">
            <button class="btn username-btn" onclick="changeUsername()">Change</button>
        </div>
        <br>
        <div class="logout-btn-container"> 
            <button class="btn" onclick="logout()">Log Out</button>
        </div>
    </div>

    <div class="pfp-container">
       <div class="pfp-display-container">
         <h3>Profile Picture</h3>
          <img id="pfp-display" src="https://res.cloudinary.com/dhptbygpt/image/upload/v1700000000/default-pfp.png" alt="Profile Picture" class="pfp-image">
       </div>
       <div class="pfp-change">
         <input type="file" id="pfp-input" class="pfp-input-field" accept="image/*">
        <button class="btn pfp-btn" onclick="changePfp()">Change PFP</button>
       </div>
    </div>
    <div id="dev-management-section" style="display: none;" class="login-container new-post-form">
        <h2>Developer Management</h2>
        <input type="email" id="dev-email-input" placeholder="Enter user's email" class="input-field"><button class="btn" onclick="openDevelopersModal()">Developers</button>
        <button id="toggle-dev-btn" class="btn username-btn">Toggle Developer Status</button>
        <p id="dev-status-message"></p>
    </div>

    <div id="developers-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDevelopersModal()">&times;</span>
            <h2>Current Developers</h2>
            <ul id="developers-list">
                </ul>
            <p id="dev-modal-status"></p>
        </div>
    </div>
    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getDatabase, ref, get, set, remove, query, orderByChild, equalTo, update as dbUpdate } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
      apiKey: "AIzaSyAUZZBN9qoM34lsvyEOeK2znSSw6kKMcEE",
      authDomain: "yikegames-website.firebaseapp.com",
      projectId: "yikegames-website",
      databaseURL: "https://yikegames-website-default-rtdb.firebaseio.com/",
      storageBucket: "yikegames-website.firebasestorage.app",
      messagingSenderId: "1086586566551",
      appId: "1:1086586566551:web:b64dfc25e6e6ac5a09b6d2",
      measurementId: "G-FXH0D07D86"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // --- Constants and DOM Elements ---
  const DEFAULT_PFP_URL = "https://res.cloudinary.com/dhptbygpt/image/upload/v1700000000/default-pfp.png";
  const CLOUDINARY_CLOUD_NAME = "dhptbygpt";
  const CLOUDINARY_UPLOAD_PRESET = "unsigned_upload";

  const devManagementSection = document.getElementById("dev-management-section");
  const devEmailInput = document.getElementById("dev-email-input");
  const toggleDevBtn = document.getElementById("toggle-dev-btn");
  const devStatusMessage = document.getElementById("dev-status-message");
  const pfpDisplay = document.getElementById("pfp-display");
  const pfpInput = document.getElementById("pfp-input");

  // Helper function to show status messages
  function showStatus(element, message, isError = false) {
      element.textContent = message;
      element.style.color = isError ? 'red' : 'inherit';
  }

  // --- Modal Management Functions (NEW) ---
  const developersModal = document.getElementById('developers-modal');
  const developersList = document.getElementById('developers-list');
  const devModalStatus = document.getElementById('dev-modal-status');

  // Open the modal, fetch data, and display it
  window.openDevelopersModal = async function() {
      developersList.innerHTML = '';
      showStatus(devModalStatus, 'Fetching developer list...');
      developersModal.style.display = 'block';

      try {
          const usersRef = ref(db, 'users');
          // Query users where isDeveloper is exactly 'true'
          // REQUIRES a '.indexOn': 'isDeveloper' rule in your RTDB rules.
          const developersQuery = query(usersRef, orderByChild('isDeveloper'), equalTo(true));
          const snapshot = await get(developersQuery);

          if (snapshot.exists()) {
              const developers = snapshot.val();
              const fragment = document.createDocumentFragment();
              let count = 0;

              Object.values(developers).forEach(userData => {
                  // Ensure the email exists before adding
                  if (userData.email) {
                      const listItem = document.createElement('li');
                      listItem.textContent = userData.email;
                      fragment.appendChild(listItem);
                      count++;
                  }
              });

              if (count > 0) {
                  developersList.appendChild(fragment);
                  showStatus(devModalStatus, `Found ${count} developer(s).`);
              } else {
                  showStatus(devModalStatus, 'No active developers found.');
              }
          } else {
              showStatus(devModalStatus, 'No developers found in the database.');
          }
      } catch (error) {
          console.error("Error fetching developers:", error);
          showStatus(devModalStatus, `Error fetching list: ${error.message}`, true);
      }
  }

  // Close the modal 
  window.closeDevelopersModal = function() {
      developersModal.style.display = 'none';
  }

  // Close the modal if the user clicks anywhere outside of it
  window.onclick = function(event) {
      if (event.target == developersModal) {
          closeDevelopersModal();
      }
  }
  // ------------------------------------------------------------------

  // --- Auth State and Initial Load ---
  onAuthStateChanged(auth, async (user) => {
      if (user) {
          document.getElementById("user-display-name").textContent = user.displayName || user.email;

          // Set PFP: Use user.photoURL or default
          pfpDisplay.src = user.photoURL || DEFAULT_PFP_URL;

          // Get user's developer status
          const userRef = ref(db, `users/${user.uid}`);
          const snapshot = await get(userRef);
          const userData = snapshot.val();

          if (userData && userData.isDeveloper) {
              devManagementSection.style.display = "flex";
          } else {
              devManagementSection.style.display = "none";
          }
      } else {
          // Redirect unauthenticated users
          window.location.href = "login.html";
      }
  });

  // --- Username Change Logic ---
  window.changeUsername = async function() {
      const newUsernameInput = document.getElementById("newUsername");
      const changeBtn = document.querySelector(".username-change .username-btn");
      const newUsername = newUsernameInput.value.trim();
      const user = auth.currentUser;

      if (!user) return alert("You must be logged in to change your username!");
      if (!newUsername) return alert("Please enter a username!");

      // NEW: Input Validation
      if (newUsername.length < 3 || newUsername.length > 20) {
          return alert("Username must be between 3 and 20 characters.");
      }
      if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
          return alert("Username can only contain letters, numbers, and underscores.");
      }
      
      // NEW: Loading State
      changeBtn.disabled = true;
      newUsernameInput.disabled = true;

      try {
          const usernameRef = ref(db, `usernames/${newUsername}`);
          const usernameSnapshot = await get(usernameRef);
          if (usernameSnapshot.exists()) {
              alert("That username is already taken. Please choose another.");
              return;
          }

          const oldUsername = user.displayName;

          // Only delete old username entry if it existed and is different
          if (oldUsername && oldUsername !== newUsername) {
              const oldUsernameRef = ref(db, `usernames/${oldUsername}`);
              await remove(oldUsernameRef);
          }
          
          // Update Firebase Auth, Realtime DB, and the uniqueness index
          await updateProfile(user, { displayName: newUsername });
          await dbUpdate(ref(db, `users/${user.uid}`), { displayName: newUsername });
          await set(ref(db, `usernames/${newUsername}`), user.uid);

          document.getElementById("user-display-name").textContent = newUsername;
          alert("Username updated successfully!");
          newUsernameInput.value = "";
      } catch (error) {
          alert("Failed to change username: " + error.message);
      } finally {
          // NEW: Reset Loading State
          changeBtn.disabled = false;
          newUsernameInput.disabled = false;
      }
  };

  // --- Profile Picture Change Logic ---
  window.changePfp = async function() {
      const file = pfpInput.files[0];
      const user = auth.currentUser;
      const changeBtn = document.querySelector(".pfp-change .pfp-btn");

      if (!user) {
          alert("You must be logged in to change your profile picture!");
          return;
      }
      if (!file) {
          alert("Please select an image to upload!");
          return;
      }

      // NEW: Loading State
      changeBtn.disabled = true;
      pfpInput.disabled = true;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

      try {
          const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
              method: 'POST',
              body: formData,
          });

          if (!response.ok) {
              throw new Error('Cloudinary upload failed!');
          }

          const data = await response.json();
          const imageUrl = data.secure_url;

          // Update user's photoURL in Firebase Auth and Realtime DB
          await updateProfile(user, { photoURL: imageUrl });
          await dbUpdate(ref(db, `users/${user.uid}`), { photoURL: imageUrl });

          // Update the image on the page
          pfpDisplay.src = imageUrl;
          
          // NEW: Reset file input
          pfpInput.value = ''; 

          alert("Profile picture updated successfully!");
      } catch (error) {
          console.error("Failed to change profile picture:", error);
          alert("Failed to change profile picture: " + error.message);
      } finally {
          // NEW: Reset Loading State
          changeBtn.disabled = false;
          pfpInput.disabled = false;
      }
  };

  // --- Logout Logic ---
  window.logout = async function() {
      try {
          await signOut(auth);
          // Assuming index.html handles the redirect logic for unauthenticated users
          window.location.href = "../index.html"; 
      } catch (error) {
          console.error("Error signing out: ", error);
      }
  };

  // --- Developer Status Toggle Logic ---
  toggleDevBtn.addEventListener('click', async () => {
      devStatusMessage.textContent = ''; // NEW: Clear previous status
      const email = devEmailInput.value.trim();
      
      if (!email) {
          showStatus(devStatusMessage, "Please enter an email.", true);
          return;
      }
      // NEW: Basic email format check
      if (!email.includes('@')) {
           showStatus(devStatusMessage, "Invalid email format.", true);
          return;
      }

      // NEW: Loading State
      toggleDevBtn.disabled = true;
      devEmailInput.disabled = true;

      try {
          // --- Search by email in the 'users' node ---
          const usersRef = ref(db, 'users');
          // Note: This query requires an index rule on 'email' in your Firebase Realtime Database security rules.
          const usersQuery = query(usersRef, orderByChild('email'), equalTo(email));
          const snapshot = await get(usersQuery);

          if (snapshot.exists()) {
              let userKey = Object.keys(snapshot.val())[0];
              let userData = snapshot.val()[userKey];
              // Determine new status and default to true if it didn't exist before
              let newStatus = !(userData.isDeveloper === true); 

              await dbUpdate(ref(db, `users/${userKey}`), { isDeveloper: newStatus });
              showStatus(devStatusMessage, `${email} is now ${newStatus ? 'a developer' : 'not a developer'}.`);
              devEmailInput.value = '';
          } else {
              showStatus(devStatusMessage, `User with email "${email}" not found.`, true);
          }
      } catch (error) {
          console.error("Error toggling developer status:", error);
          showStatus(devStatusMessage, `Error: ${error.message}`, true);
      } finally {
          // NEW: Reset Loading State
          toggleDevBtn.disabled = false;
          devEmailInput.disabled = false;
      }
  });

  // --- Page transition scripts (Keep existing) ---
  document.body.classList.add('fade-enter');
  setTimeout(() => {
      document.body.classList.add('fade-enter-active');
  }, 10);
</script>
</body>
</html>

