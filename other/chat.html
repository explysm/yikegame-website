<!DOCTYPE html>
<html lang="en" class="forums-page">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Chat</title>
<link rel="stylesheet" href="../styles/style.css">
<style>
  /* Basic Chat Styling */
  #chat-container {
    height: 400px;
    border: 1px solid #333;
    overflow-y: auto;
    padding: 10px;
    background-color: #222;
    color: #fff;
    margin-bottom: 20px;
  }
  .forum-thread {
    margin-bottom: 8px;
    word-wrap: break-word;
  }
  .chat-controls {
    display: flex;
    gap: 10px;
  }
  #message-input {
    flex-grow: 1;
    padding: 8px;
  }
  .status-message {
    text-align: center;
    margin-top: 20px;
    font-style: italic;
    color: #aaa;
  }
</style>
</head>
<body class="forums-page">
<h1>Global Chat</h1>

<div id="chat-container"></div>

<div class="chat-controls">
  <input type="text" id="message-input" placeholder="You must be logged in to chat." disabled>
  <button id="send-btn" class="username-btn" disabled>Send</button>
</div>

<p id="chat-status" class="status-message">Please log in to join the chat.</p>

<a href="/index.html" class="btn">Back</button></a>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, onDisconnect, child, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAUZZBN9qoM34lsvyEOeK2znSSw6kKMcEE",
    authDomain: "yikegames-website.firebaseapp.com",
    databaseURL: "https://yikegames-website-default-rtdb.firebaseio.com/",
    projectId: "yikegames-website",
    storageBucket: "yikegames-website.firebasestorage.app",
    messagingSenderId: "1086586566551",
    appId: "1:1086586566551:web:b64dfc25e6e6ac5a09b6d2",
    measurementId: "G-FXH0D07D86"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  let currentUserData = null;

  // DOM Elements
  const chatContainer = document.getElementById("chat-container");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const chatStatus = document.getElementById("chat-status");

  // Authentication and Presence System
  onAuthStateChanged(auth, async user => {
    if (user) {
      chatStatus.textContent = "Loading chat...";
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messageInput.placeholder = "Type your message...";
      
      const userRef = ref(db, `users/${user.uid}`);
      const userSnapshot = await get(userRef);
      if (userSnapshot.exists()) {
        currentUserData = userSnapshot.val();
      }

      // Set user as online and handle disconnect
      const onlineRef = ref(db, `.info/connected`);
      onValue(onlineRef, (snapshot) => {
        if (snapshot.val() === true) {
          const presenceRef = ref(db, `presence/${user.uid}`);
          onDisconnect(presenceRef).set(false);
          set(presenceRef, true);
        }
      });

    } else {
      currentUserData = null;
      chatStatus.textContent = "Please log in to join the chat.";
      messageInput.disabled = true;
      sendBtn.disabled = true;
      messageInput.placeholder = "You must be logged in to chat.";
      // Clear any online status on log out
      if (user) {
        set(ref(db, `presence/${user.uid}`), false);
      }
    }
  });

  // Listen for messages
  const messagesRef = ref(db, "global-chat");
  onValue(messagesRef, snapshot => {
    chatContainer.innerHTML = "";
    const data = snapshot.val();
    if (!data) return;

    // Sort by timestamp
    const messagesArray = Object.entries(data).sort((a, b) => a[1].timestamp - b[1].timestamp);

    messagesArray.forEach(([id, msg]) => {
      const div = document.createElement("div");
      div.classList.add("forum-thread");
      div.innerHTML = `<strong>${msg.author}:</strong> ${msg.text}`;
      chatContainer.appendChild(div);
    });

    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  // Send message
  sendBtn.addEventListener("click", () => {
    if (!currentUserData) return; // Prevent sending if not authenticated

    const text = messageInput.value.trim();
    if (!text) return;
    const newMsgRef = push(ref(db, "global-chat"));
    set(newMsgRef, {
      author: currentUserData.displayName,
      text,
      timestamp: serverTimestamp()
    });
    messageInput.value = "";
  });

  // Allow Enter key to send
  messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendBtn.click();
  });

  // Page transition scripts
  document.body.classList.add('fade-enter');
  setTimeout(() => {
    document.body.classList.add('fade-enter-active');
  }, 10);

  document.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href && !href.startsWith('http')) {
        e.preventDefault();
        document.body.classList.remove('fade-enter-active');
        document.body.classList.add('fade-exit-active');
        setTimeout(() => { window.location.href = href; }, 500);
      }
    });
  });
</script>
</body>
</html>
