<!DOCTYPE html>
<html lang="en" class="forums-page">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Chat</title>

<meta http-equiv="Content-Security-Policy" content="
    default-src * 'unsafe-inline' 'unsafe-eval'; 
    connect-src *;
    script-src * 'unsafe-inline' 'unsafe-eval';
">



<link rel="stylesheet" href="../styles/style.css">
<style>
  /* Basic Chat Styling */
  #chat-container {
    height: 400px;
    border: 1px solid #333;
    overflow-y: auto;
    padding: 10px;
    background-color: #222;
    color: #fff;
    margin-bottom: 20px;
  }
  .forum-thread {
    margin-bottom: 8px;
    word-wrap: break-word;
  }
  .chat-controls {
    display: flex;
    gap: 10px;
  }
  #message-input {
    flex-grow: 1;
    padding: 8px;
  }
  .status-message {
    text-align: center;
    margin-top: 20px;
    font-style: italic;
    color: #aaa;
  }
/* NEW: Ensure the highlight rule is specific enough to override existing styles */
  #chat-container .mention-highlight {
  /* Darker background for visibility */
  background-color: #555 !important; 
  /* Green border for emphasis */
  border-left: 4px solid #00ff00 !important; 
  padding: 5px;
  margin-left: -5px; /* Adjust margin to ensure border is visible */
}
</style>
</head>
<body class="forums-page">
<h1>Global Chat</h1>

<div id="chat-container"></div>

<div class="chat-controls">
  <input type="text" id="message-input" placeholder="You must be logged in to chat." disabled>
  <button id="send-btn" class="username-btn" disabled>Send</button>
</div>

<p id="chat-status" class="status-message">Please log in to join the chat.</p>

<a href="../index.html" class="btn">Back</a>

<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, onDisconnect, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAUZZBN9qoM34lsvyEOeK2znSSw6kKMcEE",
    authDomain: "yikegames-website.firebaseapp.com",
    databaseURL: "https://yikegames-website-default-rtdb.firebaseio.com/",
    projectId: "yikegames-website",
    storageBucket: "yikegames-website.firebasestorage.app",
    messagingSenderId: "1086586566551",
    appId: "1:1086586566551:web:b64dfc25e6e6ac5a09b6d2",
    measurementId: "G-FXH0D07D86"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // --- Core State Variables ---
  let currentUser = null; // Stores the Firebase Auth User object
  let currentDisplayName = null; // Stores the name used for chat/mentions
  const usersCache = {}; // Cache to store user data for faster lookup

  // Paste your Discord webhook URL here.
  const discordWebhookUrl = "https://discord.com/api/webhooks/1419226962643124336/kOCwAB9OGdalcetSAsG76w-WoaDjLW43y4DmavFgumUn383tY0TwvoEU1Goj4Oz6WeMq";

  // DOM Elements
  const chatContainer = document.getElementById("chat-container");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const chatStatus = document.getElementById("chat-status");

  // Function to get pfp URL from cache or the logged-in user object
  function getPfpUrl(authorName) {
    const defaultPfp = "https://res.cloudinary.com/dhptbygpt/image/upload/v1700000000/default-pfp.png";
    
    // Check if the author is the currently logged-in user
    if (currentUser && currentUser.displayName === authorName && currentUser.photoURL) {
      return currentUser.photoURL;
    }

    // Look up user by display name or email in the users cache
    const userKeys = Object.keys(usersCache);
    const userKey = userKeys.find(key => usersCache[key].displayName === authorName || usersCache[key].email === authorName);
    
    return userKey && usersCache[userKey].photoURL ? usersCache[userKey].photoURL : defaultPfp;
  }

  // --- Authentication and Presence System ---
  onAuthStateChanged(auth, async user => {
    currentUser = user; // Set the global user object

    if (user) {
      // 1. Set the initial display name from Auth (most reliable starting point)
      currentDisplayName = user.displayName || user.email.split('@')[0];
      
      // 2. Update UI immediately
      chatStatus.textContent = "Loading chat...";
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messageInput.placeholder = "Type your message...";
      
      // 3. Fetch richer profile data from the 'users' node
      const userRef = ref(db, `users/${user.uid}`);
      const userSnapshot = await get(userRef);
      if (userSnapshot.exists()) {
        const userData = userSnapshot.val();
        // Use the database's name if it exists and is preferred
        currentDisplayName = userData.displayName || currentDisplayName;
        // NOTE: We don't store currentUserData globally anymore, we rely on currentDisplayName
      }

      // 4. Set user as online and handle disconnect
      const onlineRef = ref(db, `.info/connected`);
      onValue(onlineRef, (snapshot) => {
        if (snapshot.val() === true) {
          const presenceRef = ref(db, `presence/${user.uid}`);
          onDisconnect(presenceRef).set(false);
          set(presenceRef, true);
        }
      });

    } else {
      currentDisplayName = null;
      currentUser = null;
      chatStatus.textContent = "Please log in to join the chat.";
      messageInput.disabled = true;
      sendBtn.disabled = true;
      messageInput.placeholder = "You must be logged in to chat.";
    }
  });

  // Listen for user data to populate cache
  const usersRef = ref(db, "users");
  onValue(usersRef, snapshot => {
    const usersData = snapshot.val();
    if (usersData) {
      Object.assign(usersCache, usersData);
    }
  });

  // --- Listen for Messages (and Highlighting Logic) ---
  const messagesRef = ref(db, "global-chat");
  onValue(messagesRef, snapshot => {
    chatContainer.innerHTML = "";
    const data = snapshot.val();
    if (!data) return;

    // Sort by timestamp
    const messagesArray = Object.entries(data).sort((a, b) => a[1].timestamp - b[1].timestamp);

    messagesArray.forEach(([id, msg]) => {
      // Safety checks
      if (!msg || !msg.text || !msg.author) {
          console.warn("Skipping incomplete chat message:", msg);
          return; 
      }

      const div = document.createElement("div");
      div.classList.add("forum-thread");

      // Check for mention: Uses lower-case comparison for reliability
      if (currentDisplayName) {
        // Standardized, lowercased name and mention string
        const currentNameLower = currentDisplayName.toLowerCase();
        const mentionStringLower = `@${currentNameLower}`;
        const messageTextLower = msg.text.toLowerCase();
        
        // 1. Check if the message is NOT from the current user (case-insensitive)
        const isNotSelf = msg.author.toLowerCase() !== currentNameLower;
        
        // 2. Check for a case-insensitive mention
        const isMentioned = messageTextLower.includes(mentionStringLower);

        if (isNotSelf && isMentioned) {
          div.classList.add("mention-highlight");
        }
      }

      div.innerHTML = `<strong>${msg.author}:</strong> ${msg.text}`;
      chatContainer.appendChild(div);
    });

    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  // --- Discord Webhook Function ---
  async function sendToDiscord(username, message, avatarUrl) {
    const payload = {
      username: username,
      content: message
    };
    
    if (avatarUrl) {
      payload.avatar_url = avatarUrl;
    }

    try {
      const response = await fetch(discordWebhookUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        console.error("Failed to send message to Discord:", response.status, response.statusText);
      }
    } catch (error) {
      console.error("Error sending message to Discord:", error);
    }
  }

  // --- Send Message Handler ---
  sendBtn.addEventListener("click", () => {
    if (!currentDisplayName) return; // Must be authenticated

    const text = messageInput.value.trim();
    if (!text) return;

    const displayName = currentDisplayName; // Use the confirmed display name
    const photoUrl = getPfpUrl(displayName);

    // Send to Firebase 
    const newMsgRef = push(ref(db, "global-chat"));
    set(newMsgRef, {
      author: displayName,
      text,
      // Use Firebase server timestamp for accurate sorting
      timestamp: serverTimestamp() 
    });

    // Send to Discord
    sendToDiscord(displayName, text, photoUrl);

    // Clear message input
    messageInput.value = "";
  });

  // Allow Enter key to send
  messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !messageInput.disabled) {
        e.preventDefault(); // Prevent accidental form submission
        sendBtn.click();
    }
  });

  // --- Page Transition Scripts ---
  document.body.classList.add('fade-enter');
  setTimeout(() => {
    document.body.classList.add('fade-enter-active');
  }, 10);

  document.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href && !href.startsWith('http')) {
        e.preventDefault();
        document.body.classList.remove('fade-enter-active');
        document.body.classList.add('fade-exit-active');
        setTimeout(() => { window.location.href = href; }, 500);
      }
    });
  });


</script>
</body>
</html>

