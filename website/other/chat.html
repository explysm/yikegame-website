<!DOCTYPE html>
<html lang="en" class="forums-page">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Chat</title>
<link rel="stylesheet" href="../styles/style.css">
<style>
  /* Basic Chat Styling */
  #chat-container {
    height: 400px;
    border: 1px solid #333;
    overflow-y: auto;
    padding: 10px;
    background-color: #222;
    color: #fff;
    margin-bottom: 20px;
  }
  .forum-thread {
    margin-bottom: 8px;
    word-wrap: break-word;
  }
  .chat-controls {
    display: flex;
    gap: 10px;
  }
  #message-input {
    flex-grow: 1;
    padding: 8px;
  }
  .status-message {
    text-align: center;
    margin-top: 20px;
    font-style: italic;
    color: #aaa;
  }
</style>
</head>
<body class="forums-page">
<h1>Global Chat</h1>

<div id="chat-container"></div>

<div class="chat-controls">
  <input type="text" id="message-input" placeholder="You must be logged in to chat." disabled>
  <button id="send-btn" class="username-btn" disabled>Send</button>
</div>

<p id="chat-status" class="status-message">Please log in to join the chat.</p>

<a href="/index.html" class="btn">Back</button></a>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, onDisconnect, child, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAUZZBN9qoM34lsvyEOeK2znSSw6kKMcEE",
    authDomain: "yikegames-website.firebaseapp.com",
    databaseURL: "https://yikegames-website-default-rtdb.firebaseio.com/",
    projectId: "yikegames-website",
    storageBucket: "yikegames-website.firebasestorage.app",
    messagingSenderId: "1086586566551",
    appId: "1:1086586566551:web:b64dfc25e6e6ac5a09b6d2",
    measurementId: "G-FXH0D07D86"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  let currentUserData = null;
  const usersCache = {}; // Cache to store user data for faster lookup

  // Paste your Discord webhook URL here.
  // WARNING: This URL will be publicly visible in your open-source code.
  const discordWebhookUrl = "https://discord.com/api/webhooks/1419226962643124336/kOCwAB9OGdalcetSAsG76w-WoaDjLW43y4DmavFgumUn383tY0TwvoEU1Goj4Oz6WeMq";

  // DOM Elements
  const chatContainer = document.getElementById("chat-container");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const chatStatus = document.getElementById("chat-status");

  // Function to get pfp URL from cache
  function getPfpUrl(authorName) {
    const userKeys = Object.keys(usersCache);
    const user = userKeys.find(key => usersCache[key].displayName === authorName || usersCache[key].email === authorName);
    return user && usersCache[user].photoURL ? usersCache[user].photoURL : "https://res.cloudinary.com/dhptbygpt/image/upload/v1700000000/default-pfp.png";
  }

  // Authentication and Presence System
  onAuthStateChanged(auth, async user => {
    if (user) {
      chatStatus.textContent = "Loading chat...";
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messageInput.placeholder = "Type your message...";
      
      const userRef = ref(db, `users/${user.uid}`);
      const userSnapshot = await get(userRef);
      if (userSnapshot.exists()) {
        currentUserData = userSnapshot.val();
      }

      // Set user as online and handle disconnect
      const onlineRef = ref(db, `.info/connected`);
      onValue(onlineRef, (snapshot) => {
        if (snapshot.val() === true) {
          const presenceRef = ref(db, `presence/${user.uid}`);
          onDisconnect(presenceRef).set(false);
          set(presenceRef, true);
        }
      });

    } else {
      currentUserData = null;
      chatStatus.textContent = "Please log in to join the chat.";
      messageInput.disabled = true;
      sendBtn.disabled = true;
      messageInput.placeholder = "You must be logged in to chat.";
      // Clear any online status on log out
      if (user) {
        set(ref(db, `presence/${user.uid}`), false);
      }
    }
  });

  // Listen for user data to populate cache
  const usersRef = ref(db, "users");
  onValue(usersRef, snapshot => {
    const usersData = snapshot.val();
    if (usersData) {
      Object.assign(usersCache, usersData);
    }
  });

  // Listen for messages
  const messagesRef = ref(db, "global-chat");
  onValue(messagesRef, snapshot => {
    chatContainer.innerHTML = "";
    const data = snapshot.val();
    if (!data) return;

    // Sort by timestamp
    const messagesArray = Object.entries(data).sort((a, b) => a[1].timestamp - b[1].timestamp);

    messagesArray.forEach(([id, msg]) => {
      const div = document.createElement("div");
      div.classList.add("forum-thread");
      div.innerHTML = `<strong>${msg.author}:</strong> ${msg.text}`;
      chatContainer.appendChild(div);
    });

    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  // Function to send a message to Discord with the user's avatar
  async function sendToDiscord(username, message, avatarUrl) {
    const payload = {
      username: username,
      content: message
    };
    
    // Conditionally add the avatar_url if one is provided
    if (avatarUrl) {
      payload.avatar_url = avatarUrl;
    }

    try {
      const response = await fetch(discordWebhookUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        console.error("Failed to send message to Discord:", response.status, response.statusText);
      }
    } catch (error) {
      console.error("Error sending message to Discord:", error);
    }
  }

  // Send message to Firebase and Discord
  sendBtn.addEventListener("click", () => {
    if (!currentUserData) return; // Prevent sending if not authenticated

    const text = messageInput.value.trim();
    if (!text) return;

    // Get the display name and photo URL using the getPfpUrl function
    const displayName = currentUserData.displayName;
    const photoUrl = getPfpUrl(displayName);

    // Send to Firebase (your existing code)
    const newMsgRef = push(ref(db, "global-chat"));
    set(newMsgRef, {
      author: displayName,
      text,
      timestamp: serverTimestamp()
    });

    // Send to Discord with the user's display name and photo URL
    sendToDiscord(displayName, text, photoUrl);

    // Clear message input
    messageInput.value = "";
  });

  // Allow Enter key to send
  messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendBtn.click();
  });

  // Page transition scripts
  document.body.classList.add('fade-enter');
  setTimeout(() => {
    document.body.classList.add('fade-enter-active');
  }, 10);

  document.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href && !href.startsWith('http')) {
        e.preventDefault();
        document.body.classList.remove('fade-enter-active');
        document.body.classList.add('fade-exit-active');
        setTimeout(() => { window.location.href = href; }, 500);
      }
    });
  });
</script>
</body>
</html>
