<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Main Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="styles/style.css">

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAUZZBN9qoM34lsvyEOeK2znSSw6kKMcEE",
    authDomain: "yikegames-website.firebaseapp.com",
    projectId: "yikegames-website",
    storageBucket: "yikegames-website.firebasestorage.app",
    messagingSenderId: "1086586566551",
    appId: "1:1086586566551:web:b64dfc25e6e6ac5a09b6d2",
    measurementId: "G-FXH0D07D86"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Show username and toggle username-change input
  onAuthStateChanged(auth, async (user) => {
    const usernameEl = document.getElementById("username-display");
    const changeDiv = document.getElementById("username-change");

    if (user) {
      // Load displayName from Realtime DB if exists
      const userRef = ref(db, 'users/' + user.uid);
      const snapshot = await get(userRef);
      let name;
      if (snapshot.exists() && snapshot.val().displayName) {
        name = snapshot.val().displayName;
      } else {
        name = user.displayName || user.email;
        // Write to DB if missing
        set(userRef, { displayName: name, email: user.email });
      }

      usernameEl.textContent = `Logged in as: ${name}`;
      changeDiv.style.display = "flex";
    } else {
      usernameEl.textContent = "";
      changeDiv.style.display = "none";
    }
  });

  // Change username function (checks DB for duplicates)
  window.changeUsername = async function() {
    const newName = document.getElementById("newUsername").value.trim();
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in to change your username!");
    if (!newName) return alert("Please enter a username!");

    // Check if username is taken
    const usersRef = ref(db, 'users/');
    const snapshot = await get(usersRef);
    if (snapshot.exists()) {
      const allUsers = snapshot.val();
      for (const uid in allUsers) {
        if (allUsers[uid].displayName === newName && uid !== user.uid) {
          return alert("This username is already taken!");
        }
      }
    }

    try {
      // Update Firebase Auth profile
      await updateProfile(user, { displayName: newName });
      // Update Realtime Database
      await set(ref(db, 'users/' + user.uid), { displayName: newName, email: user.email });
      document.getElementById("username-display").textContent = `Logged in as: ${newName}`;
      alert("Username updated!");
      document.getElementById("newUsername").value = "";
    } catch (error) {
      alert(error.message);
    }
  };
</script>
</head>
<body>
<header>
    <h1>Welcome to the home page!</h1>
    <p class="subtitle">Go to any section using the buttons below</p>
    <a href="other/login.html"><button class="btn login-btn">Login / Register</button></a>
</header>

<section class="user-info">
  <p id="username-display"></p>
  <div id="username-change" class="username-change">
    <input type="text" id="newUsername" placeholder="New Username" class="input-field">
    <button class="btn username-btn" onclick="changeUsername()">Change</button>
  </div>
</section>

<section class="buttons-center">
    <a href="games/games.html"><button class="btn">Games</button></a>
    <a href="other/aboutme.html"><button class="btn">About Me</button></a>
    <a href="other/chat.html"><button class="btn">Global Chat</button></a>
</section>

<section class="warning">
    <p class="warning1">⚠️ This site is designed for desktop. Mobile experience may be limited. ⚠️</p>
</section>

<section class="web">
    <a href="http://www.yikegames.qzz.io">yikegames.qzz.io</a><br>
    <a href="https://yikegames.itch.io">yikegames.itch.io</a><br>
    <a href="https://github.com/explysm">github.com/explysm</a><br>
</section>
<h1>--------- Socials ---------</h1><br>
<section class="web">
    <a href="https://x.com/AsnCEe">Twitter</a><br>
</section>

<section id="commits" class="updates">
  <h2>Latest Updates</h2>
  <ul id="commit-list"></ul>
</section>

<script>
async function loadCommits() {
  const repo = "explysm/yikegame-website";
  const response = await fetch(`https://api.github.com/repos/${repo}/commits`);
  const commits = await response.json();
  const list = document.getElementById("commit-list");
  list.innerHTML = "";
  commits.slice(0, 5).forEach(c => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${c.commit.author.name}</strong>: ${c.commit.message} 
                    <br><small>${new Date(c.commit.author.date).toLocaleString()}</small>`;
    list.appendChild(li);
  });
}
loadCommits();
</script>

<script>
  document.body.classList.add('fade-enter');
  setTimeout(() => {
    document.body.classList.add('fade-enter-active');
  }, 10);

  document.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href && !href.startsWith('http')) {
        e.preventDefault();
        document.body.classList.remove('fade-enter-active');
        document.body.classList.add('fade-exit-active');
        setTimeout(() => { window.location.href = href; }, 500);
      }
    });
  });
</script>
</body>
</html>