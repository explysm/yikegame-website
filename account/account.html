<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Account</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="stylesheet" href="account.css">
</head>
<body>
    <a href="../index.html" class="back-arrow">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
    </a>
    <div class="account-container">
        <aside class="sidebar">
            <div class="user-card">
                <img id="pfp-display" src="https://res.cloudinary.com/dhptbygpt/image/upload/v1700000000/default-pfp.png" alt="Profile Picture" class="pfp-image">
                <h2 id="user-display-name"></h2>
                <p>Joined <span id="user-join-date"></span></p>
                <a id="view-profile-btn" href="#" class="btn">View Profile</a>
            </div>
            <nav class="account-nav">
                <a href="#" class="nav-item active" data-tab="account">Account Settings</a>
                <a href="#" class="nav-item" data-tab="profile">Edit Profile</a>
                <a href="#" class="nav-item" data-tab="socials">Social Links</a>
                <a href="#" class="nav-item" data-tab="developer" id="developer-tab" style="display: none;">Developer</a>
            </nav>
            <div class="logout-btn-container">
                <button class="btn" onclick="logout()">Log Out</button>
            </div>
        </aside>
        <main class="main-content">
            <div class="tab-content active" id="account-tab">
                <h3>Account Settings</h3>
                <div class="form-group">
                    <label for="newUsername">Change Username</label>
                    <input type="text" id="newUsername" placeholder="New Username" class="input-field">
                    <button class="btn username-btn" onclick="changeUsername()">Change</button>
                </div>
                <div class="form-group">
                    <label for="pfp-input">Change Profile Picture</label>
                    <input type="file" id="pfp-input" class="pfp-input-field" accept="image/*">
                    <button class="btn pfp-btn" onclick="changePfp()">Change PFP</button>
                </div>
            </div>
            <div class="tab-content" id="profile-tab">
                <h3>Edit Profile</h3>
                <form id="edit-profile-form" class="edit-profile-form">
                    <div class="form-group">
                        <label for="bio">Your Bio</label>
                        <textarea id="bio" class="input-field" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="accent-color">Accent Color</label>
                        <input type="color" id="accent-color" class="input-field" value="#333333">
                    </div>
                    <div class="form-group">
                        <label for="button-hover-color">Button Hover Color</label>
                        <input type="color" id="button-hover-color" class="input-field" value="#444444">
                    </div>
                    <div class="form-group">
                        <label for="profile-background-color">Profile Background Color</label>
                        <input type="color" id="profile-background-color" class="input-field" value="#1e1e1e">
                    </div>
                    <button type="submit" class="btn">Save Changes</button>
                </form>
            </div>
            <div class="tab-content" id="socials-tab">
                <h3>Social Links</h3>
                <form id="socials-form" class="edit-profile-form">
                    <div class="form-group">
                        <label for="twitter">Twitter Handle</label>
                        <input type="text" id="twitter" class="input-field" placeholder="Your Twitter username">
                    </div>
                    <div class="form-group">
                        <label for="github">GitHub Handle</label>
                        <input type="text" id="github" class="input-field" placeholder="Your GitHub username">
                    </div>
                    <button type="submit" class="btn">Save Changes</button>
                </form>
            </div>
            <div class="tab-content" id="developer-tab-content">
                <h3>Developer Management</h3>
                <div class="form-group">
                    <label for="dev-email-input">User Email</label>
                    <input type="email" id="dev-email-input" placeholder="Enter user's email" class="input-field">
                </div>
                <button id="toggle-dev-btn" class="btn username-btn">Toggle Developer Status</button>
                <p id="dev-status-message"></p>
                <button class="btn" onclick="openDevelopersModal()">View Developers</button>
            </div>
        </main>
    </div>

    <div id="developers-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDevelopersModal()">&times;</span>
            <h2>Current Developers</h2>
            <ul id="developers-list">
                </ul>
            <p id="dev-modal-status"></p>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, get, set, remove, query, orderByChild, equalTo, update as dbUpdate } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUZZBN9qoM34lsvyEOeK2znSSw6kKMcEE",
            authDomain: "yikegames-website.firebaseapp.com",
            projectId: "yikegames-website",
            databaseURL: "https://yikegames-website-default-rtdb.firebaseio.com/",
            storageBucket: "yikegames-website.firebasestorage.app",
            messagingSenderId: "1086586566551",
            appId: "1:1086586566551:web:b64dfc25e6e6ac5a09b6d2",
            measurementId: "G-FXH0D07D86"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Constants and DOM Elements ---
        const DEFAULT_PFP_URL = "https://res.cloudinary.com/dhptbygpt/image/upload/v1700000000/default-pfp.png";
        const CLOUDINARY_CLOUD_NAME = "dhptbygpt";
        const CLOUDINARY_UPLOAD_PRESET = "unsigned_upload";

        const devEmailInput = document.getElementById("dev-email-input");
        const toggleDevBtn = document.getElementById("toggle-dev-btn");
        const devStatusMessage = document.getElementById("dev-status-message");
        const pfpDisplay = document.getElementById("pfp-display");
        const pfpInput = document.getElementById("pfp-input");
        const developerTab = document.getElementById("developer-tab");

        // Helper function to show status messages
        function showStatus(element, message, isError = false) {
            element.textContent = message;
            element.style.color = isError ? 'red' : 'inherit';
        }

        // --- Modal Management Functions (NEW) ---
        const developersModal = document.getElementById('developers-modal');
        const developersList = document.getElementById('developers-list');
        const devModalStatus = document.getElementById('dev-modal-status');

        window.openDevelopersModal = async function() {
            developersList.innerHTML = '';
            showStatus(devModalStatus, 'Fetching developer list...');
            developersModal.style.display = 'block';

            try {
                const usersRef = ref(db, 'users');
                const developersQuery = query(usersRef, orderByChild('isDeveloper'), equalTo(true));
                const snapshot = await get(developersQuery);

                if (snapshot.exists()) {
                    const developers = snapshot.val();
                    const fragment = document.createDocumentFragment();
                    let count = 0;

                    Object.values(developers).forEach(userData => {
                        if (userData.email) {
                            const listItem = document.createElement('li');
                            listItem.textContent = userData.email;
                            fragment.appendChild(listItem);
                            count++;
                        }
                    });

                    if (count > 0) {
                        developersList.appendChild(fragment);
                        showStatus(devModalStatus, `Found ${count} developer(s).`);
                    } else {
                        showStatus(devModalStatus, 'No active developers found.');
                    }
                } else {
                    showStatus(devModalStatus, 'No developers found in the database.');
                }
            } catch (error) {
                console.error("Error fetching developers:", error);
                showStatus(devModalStatus, `Error fetching list: ${error.message}`, true);
            }
        }

        window.closeDevelopersModal = function() {
            developersModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == developersModal) {
                closeDevelopersModal();
            }
        }

        // --- Auth State and Initial Load ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById("user-display-name").textContent = user.displayName || user.email;
                document.getElementById("user-join-date").textContent = new Date(user.metadata.creationTime).toLocaleDateString();
                pfpDisplay.src = user.photoURL || DEFAULT_PFP_URL;
                document.getElementById('view-profile-btn').href = `profile.html?uid=${user.uid}`;

                const userRef = ref(db, `users/${user.uid}`);
                const snapshot = await get(userRef);
                const userData = snapshot.val();

                if (userData && !userData.creationTime) {
                    dbUpdate(ref(db, `users/${user.uid}`), { creationTime: user.metadata.creationTime });
                }

                if (userData && userData.isDeveloper === true) {
                    developerTab.style.display = "block";
                } else {
                    developerTab.style.display = "none";
                }

                if (userData && userData.profile) {
                    document.getElementById('bio').value = userData.profile.description || '';
                    if (userData.profile.socials) {
                        document.getElementById('twitter').value = userData.profile.socials.twitter || '';
                        document.getElementById('github').value = userData.profile.socials.github || '';
                    }
                    if (userData.profile.accentColor) {
                        document.getElementById('accent-color').value = userData.profile.accentColor;
                    }
                    if (userData.profile.buttonHoverColor) {
                        document.getElementById('button-hover-color').value = userData.profile.buttonHoverColor;
                    }
                    if (userData.profile.profileBackgroundColor) {
                        document.getElementById('profile-background-color').value = userData.profile.profileBackgroundColor;
                    }
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // --- Username Change Logic ---
        window.changeUsername = async function() {
            const newUsernameInput = document.getElementById("newUsername");
            const changeBtn = document.querySelector(".username-btn");
            const newUsername = newUsernameInput.value.trim();
            const user = auth.currentUser;

            if (!user) return alert("You must be logged in to change your username!");
            if (!newUsername) return alert("Please enter a username!");

            if (newUsername.length < 3 || newUsername.length > 20) {
                return alert("Username must be between 3 and 20 characters.");
            }
            if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                return alert("Username can only contain letters, numbers, and underscores.");
            }
            
            changeBtn.disabled = true;
            newUsernameInput.disabled = true;

            try {
                const usernameRef = ref(db, `usernames/${newUsername}`);
                const usernameSnapshot = await get(usernameRef);
                if (usernameSnapshot.exists()) {
                    alert("That username is already taken. Please choose another.");
                    return;
                }

                const oldUsername = user.displayName;

                if (oldUsername && oldUsername !== newUsername) {
                    const oldUsernameRef = ref(db, `usernames/${oldUsername}`);
                    await remove(oldUsernameRef);
                }
                
                await updateProfile(user, { displayName: newUsername });
                await dbUpdate(ref(db, `users/${user.uid}`), { displayName: newUsername });
                await set(ref(db, `usernames/${newUsername}`), user.uid);

                document.getElementById("user-display-name").textContent = newUsername;
                alert("Username updated successfully!");
                newUsernameInput.value = "";
            } catch (error) {
                alert("Failed to change username: " + error.message);
            } finally {
                changeBtn.disabled = false;
                newUsernameInput.disabled = false;
            }
        };

        // --- Profile Picture Change Logic ---
        window.changePfp = async function() {
            const file = pfpInput.files[0];
            const user = auth.currentUser;
            const changeBtn = document.querySelector(".pfp-btn");

            if (!user) return alert("You must be logged in to change your profile picture!");
            if (!file) return alert("Please select an image to upload!");

            changeBtn.disabled = true;
            pfpInput.disabled = true;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) throw new Error('Cloudinary upload failed!');

                const data = await response.json();
                const imageUrl = data.secure_url;

                await updateProfile(user, { photoURL: imageUrl });
                await dbUpdate(ref(db, `users/${user.uid}`), { photoURL: imageUrl });

                pfpDisplay.src = imageUrl;
                pfpInput.value = ''; 

                alert("Profile picture updated successfully!");
            } catch (error) {
                console.error("Failed to change profile picture:", error);
                alert("Failed to change profile picture: " + error.message);
            } finally {
                changeBtn.disabled = false;
                pfpInput.disabled = false;
            }
        };

        // --- Logout Logic ---
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = "../index.html"; 
            } catch (error) {
                console.error("Error signing out: ", error);
            }
        };

        // --- Developer Status Toggle Logic ---
        toggleDevBtn.addEventListener('click', async () => {
            devStatusMessage.textContent = '';
            const email = devEmailInput.value.trim();
            
            if (!email) return showStatus(devStatusMessage, "Please enter an email.", true);
            if (!email.includes('@')) return showStatus(devStatusMessage, "Invalid email format.", true);

            toggleDevBtn.disabled = true;
            devEmailInput.disabled = true;

            try {
                const usersRef = ref(db, 'users');
                const usersQuery = query(usersRef, orderByChild('email'), equalTo(email));
                const snapshot = await get(usersQuery);

                if (snapshot.exists()) {
                    let userKey = Object.keys(snapshot.val())[0];
                    let userData = snapshot.val()[userKey];
                    let newStatus = !(userData.isDeveloper === true); 

                    await dbUpdate(ref(db, `users/${userKey}`), { isDeveloper: newStatus });
                    showStatus(devStatusMessage, `${email} is now ${newStatus ? 'a developer' : 'not a developer'}.`);
                    devEmailInput.value = '';
                } else {
                    showStatus(devStatusMessage, `User with email "${email}" not found.`, true);
                }
            } catch (error) {
                console.error("Error toggling developer status:", error);
                showStatus(devStatusMessage, `Error: ${error.message}`, true);
            } finally {
                toggleDevBtn.disabled = false;
                devEmailInput.disabled = false;
            }
        });

        // --- Edit Profile Logic ---
        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const profileData = {
                description: document.getElementById('bio').value,
                accentColor: document.getElementById('accent-color').value,
                buttonHoverColor: document.getElementById('button-hover-color').value,
                profileBackgroundColor: document.getElementById('profile-background-color').value
            };

            const userProfileRef = ref(db, `users/${user.uid}/profile`);
            await dbUpdate(userProfileRef, profileData);

            alert('Profile updated successfully!');
        });

        // --- Socials Logic ---
        document.getElementById('socials-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const socialData = {
                socials: {
                    twitter: document.getElementById('twitter').value,
                    github: document.getElementById('github').value
                }
            };

            const userProfileRef = ref(db, `users/${user.uid}/profile`);
            await dbUpdate(userProfileRef, socialData);

            alert('Social links updated successfully!');
        });

        // --- Tab Switching Logic ---
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();

                navItems.forEach(i => i.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                item.classList.add('active');

const tabId = item.getAttribute('data-tab');
            if (tabId === 'developer') {
                // Special handling for the developer tab due to the ID change
                document.getElementById('developer-tab-content').classList.add('active');
            } else {
                const tabContent = document.getElementById(tabId + '-tab');
                if (tabContent) {
                    tabContent.classList.add('active');
                }
            }
            });
        });
    </script>
</body>
</html>
